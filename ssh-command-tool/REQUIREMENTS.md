# SSH Command Tool 3 - 要求定義書

## 1. プロジェクト概要

### 1.1 目的
SSH経由でリモートマシンに接続し、Chrome DevTools Protocol (CDP) を活用したブラウザのリモートデバッグ・自動化を実現するツールを構築する。

### 1.2 対象ユーザー
- Web開発者・QAエンジニア
- DevOps/SREエンジニア
- 自動化テストエンジニア
- セキュリティテスター

### 1.3 解決する課題
1. リモートサーバー上のブラウザをローカルからデバッグ・操作したい
2. SSH経由で安全にポートフォワーディングを行いたい
3. ブラウザの操作・監視を自動化したい
4. ネットワークリクエストの記録・分析をしたい

---

## 2. 機能要求 (Functional Requirements)

### 2.1 SSH接続管理 (FR-SSH)

| ID | 要求 | 優先度 |
|----|------|--------|
| FR-SSH-001 | パスワード認証によるSSH接続 | Must |
| FR-SSH-002 | 秘密鍵認証によるSSH接続 | Must |
| FR-SSH-003 | パスフレーズ付き秘密鍵のサポート | Should |
| FR-SSH-004 | SSH接続情報の保存・管理 | Must |
| FR-SSH-005 | 接続プール機能（複数接続の管理） | Should |
| FR-SSH-006 | 接続のタイムアウト設定 | Must |
| FR-SSH-007 | 自動再接続機能 | Should |
| FR-SSH-008 | SSH Keep-Alive機能 | Must |

### 2.2 ポートフォワーディング (FR-PF)

| ID | 要求 | 優先度 |
|----|------|--------|
| FR-PF-001 | ローカル→リモートポートフォワーディング | Must |
| FR-PF-002 | リモート→ローカルポートフォワーディング | Should |
| FR-PF-003 | 動的ポートフォワーディング（SOCKS5） | Could |
| FR-PF-004 | 複数ポートの同時フォワーディング | Should |
| FR-PF-005 | フォワーディング状態の監視・表示 | Must |

### 2.3 Chrome DevTools Protocol (FR-CDP)

| ID | 要求 | 優先度 |
|----|------|--------|
| FR-CDP-001 | リモートChromeへの接続 | Must |
| FR-CDP-002 | ページナビゲーション制御 | Must |
| FR-CDP-003 | スクリーンショット取得 | Must |
| FR-CDP-004 | ネットワークリクエスト監視・記録 | Must |
| FR-CDP-005 | JavaScript実行 | Should |
| FR-CDP-006 | DOM要素の取得・操作 | Should |
| FR-CDP-007 | パフォーマンスメトリクス取得 | Should |
| FR-CDP-008 | コンソールログ監視 | Should |
| FR-CDP-009 | PDF出力 | Could |

### 2.4 リモートChrome管理 (FR-RC)

| ID | 要求 | 優先度 |
|----|------|--------|
| FR-RC-001 | リモートChromeの起動（デバッグモード） | Must |
| FR-RC-002 | Chrome起動オプションの設定 | Must |
| FR-RC-003 | ヘッドレスモードサポート | Must |
| FR-RC-004 | Chrome終了・クリーンアップ | Must |
| FR-RC-005 | 既存Chromeセッションへの接続 | Should |
| FR-RC-006 | Chromeバージョン検出 | Should |

### 2.5 設定管理 (FR-CFG)

| ID | 要求 | 優先度 |
|----|------|--------|
| FR-CFG-001 | 接続設定の永続化（JSON形式） | Must |
| FR-CFG-002 | パスワード・秘密鍵の安全な保存 | Must |
| FR-CFG-003 | デフォルト設定の管理 | Should |
| FR-CFG-004 | 設定のインポート・エクスポート | Could |

### 2.6 ユーザーインターフェース (FR-UI)

| ID | 要求 | 優先度 |
|----|------|--------|
| FR-UI-001 | コマンドラインインターフェース (CLI) | Must |
| FR-UI-002 | 対話型メニュー | Should |
| FR-UI-003 | Web GUI | Should |
| FR-UI-004 | リアルタイムログ表示 | Must |
| FR-UI-005 | 進捗・状態インジケーター | Should |

---

## 3. 非機能要求 (Non-Functional Requirements)

### 3.1 パフォーマンス (NFR-PERF)

| ID | 要求 | 目標値 |
|----|------|--------|
| NFR-PERF-001 | SSH接続確立時間 | < 5秒 |
| NFR-PERF-002 | ポートフォワーディング開始時間 | < 1秒 |
| NFR-PERF-003 | CDP接続確立時間 | < 3秒 |
| NFR-PERF-004 | スクリーンショット取得時間 | < 2秒 |
| NFR-PERF-005 | メモリ使用量 | < 200MB |

### 3.2 信頼性 (NFR-REL)

| ID | 要求 | 目標値 |
|----|------|--------|
| NFR-REL-001 | 接続エラー時の自動リカバリ | 3回までリトライ |
| NFR-REL-002 | グレースフルシャットダウン | 全リソース確実に解放 |
| NFR-REL-003 | エラーハンドリング | 全例外をキャッチ・ログ |

### 3.3 セキュリティ (NFR-SEC)

| ID | 要求 |
|----|------|
| NFR-SEC-001 | パスワードのメモリ上での安全な扱い |
| NFR-SEC-002 | 設定ファイルの適切なパーミッション (0600) |
| NFR-SEC-003 | 秘密鍵ファイルの検証 |
| NFR-SEC-004 | SSHホストキー検証オプション |

### 3.4 保守性 (NFR-MAIN)

| ID | 要求 |
|----|------|
| NFR-MAIN-001 | モジュラーアーキテクチャ |
| NFR-MAIN-002 | 依存性注入によるテスタビリティ |
| NFR-MAIN-003 | 包括的なユニットテスト (カバレッジ 80%以上) |
| NFR-MAIN-004 | TypeScript型安全性 |

### 3.5 可用性 (NFR-AVAIL)

| ID | 要求 |
|----|------|
| NFR-AVAIL-001 | macOS 12+ サポート |
| NFR-AVAIL-002 | Linux (Ubuntu 20.04+) サポート |
| NFR-AVAIL-003 | Bun 1.1.0+ ランタイム |

---

## 4. ユースケース

### UC-001: リモートChromeでWebページをデバッグ

**アクター**: 開発者
**前提条件**: リモートサーバーにSSHアクセス可能、Chromeインストール済み

**基本フロー**:
1. ユーザーがSSH接続情報を入力/選択
2. システムがSSH接続を確立
3. システムがリモートでChromeをデバッグモードで起動
4. システムがポートフォワーディングを設定
5. ユーザーがローカルからCDP経由でChromeに接続
6. ユーザーがページナビゲーション・デバッグを実行
7. セッション終了時、Chromeを終了しクリーンアップ

### UC-002: ネットワークリクエストの記録

**アクター**: QAエンジニア
**前提条件**: UC-001の接続確立済み

**基本フロー**:
1. ユーザーがネットワーク監視を開始
2. ユーザーが対象URLへナビゲート
3. システムが全HTTPリクエスト/レスポンスを記録
4. ユーザーが監視を停止
5. 記録データをJSON形式でエクスポート

### UC-003: 自動スクリーンショット取得

**アクター**: テストエンジニア
**前提条件**: UC-001の接続確立済み

**基本フロー**:
1. ユーザーがURLリストを指定
2. システムが各URLに順次ナビゲート
3. 各ページでスクリーンショットを取得
4. 画像ファイルとして保存

---

## 5. 制約事項

### 5.1 技術的制約
- Bun 1.1.0以上が必要
- Chrome/Chromiumがリモートサーバーにインストールされている必要がある
- SSHポート（通常22）へのアクセスが必要

### 5.2 運用上の制約
- 認証情報はローカルファイルシステムに保存
- 同時接続数は最大10接続まで

---

## 6. 用語集

| 用語 | 説明 |
|------|------|
| CDP | Chrome DevTools Protocol - Chromeをプログラムで制御するプロトコル |
| SSH | Secure Shell - 安全なリモート接続プロトコル |
| ポートフォワーディング | SSHトンネル経由でポートをローカルに転送する機能 |
| ヘッドレスモード | GUIなしでブラウザを実行するモード |

---

## 7. 参考資料

- [Chrome DevTools Protocol Documentation](https://chromedevtools.github.io/devtools-protocol/)
- [ssh2 npm package](https://www.npmjs.com/package/ssh2)
- [Bun Documentation](https://bun.sh/docs)
