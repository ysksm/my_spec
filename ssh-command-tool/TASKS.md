# SSH Command Tool 3 - タスクプラン

## 概要

このドキュメントは、ssh-command-tool3をゼロから再構築するための詳細なタスクプランです。
6つのフェーズに分けて段階的に実装を進めます。

---

## フェーズ 0: プロジェクト初期化

### P0-1: 基盤構築

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P0-1-1 | プロジェクトディレクトリ構造作成 | packages/core, cli, gui の構成 | - |
| P0-1-2 | ルートpackage.json設定 | ワークスペース設定、スクリプト定義 | P0-1-1 |
| P0-1-3 | TypeScript設定 | tsconfig.json (base, core, cli, gui) | P0-1-1 |
| P0-1-4 | Biome設定 | biome.json (lint, format rules) | P0-1-1 |
| P0-1-5 | Git設定 | .gitignore, pre-commit hooks | P0-1-1 |

### P0-2: コアパッケージ初期化

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P0-2-1 | core/package.json作成 | 依存関係: ssh2, eventemitter3 | P0-1-2 |
| P0-2-2 | 型定義ファイル作成 | types/index.ts - 基本型定義 | P0-2-1 |
| P0-2-3 | エラークラス定義 | errors.ts - カスタムエラー | P0-2-1 |
| P0-2-4 | ユーティリティ関数 | utils.ts - 共通ヘルパー | P0-2-1 |

**完了条件**: `bun install` が成功し、TypeScriptのビルドが通ること

---

## フェーズ 1: SSHモジュール実装

### P1-1: SSHClient実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P1-1-1 | SSHClient基本クラス | 接続/切断の基本機能 | P0-2 |
| P1-1-2 | パスワード認証実装 | password authType対応 | P1-1-1 |
| P1-1-3 | 秘密鍵認証実装 | privateKey authType対応 | P1-1-1 |
| P1-1-4 | コマンド実行機能 | exec()メソッド実装 | P1-1-1 |
| P1-1-5 | Keep-Alive実装 | 定期的なping送信 | P1-1-1 |
| P1-1-6 | イベントエミッター統合 | ready, close, error, timeout | P1-1-1 |
| P1-1-7 | SSHClientテスト作成 | ユニットテスト + モック | P1-1-6 |

### P1-2: 認証ユーティリティ

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P1-2-1 | 秘密鍵読み込み機能 | ファイルパス/Buffer対応 | P1-1-3 |
| P1-2-2 | 秘密鍵形式検出 | RSA, Ed25519, ECDSA判定 | P1-2-1 |
| P1-2-3 | パスフレーズ検証 | 暗号化された鍵の判定 | P1-2-1 |
| P1-2-4 | SSH設定読み込み | ~/.ssh/config パース | P1-2-1 |

### P1-3: ConnectionPool実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P1-3-1 | ConnectionPool基本クラス | 接続の追加/削除/取得 | P1-1-7 |
| P1-3-2 | 接続状態管理 | ConnectionState enum | P1-3-1 |
| P1-3-3 | 自動再接続機能 | exponential backoff | P1-3-1 |
| P1-3-4 | アイドルタイムアウト | 未使用接続の自動切断 | P1-3-1 |
| P1-3-5 | 一括コマンド実行 | execAll()実装 | P1-3-1 |
| P1-3-6 | ConnectionPoolテスト | ユニットテスト | P1-3-5 |

### P1-4: PortForwarder実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P1-4-1 | PortForwarder基本クラス | フォワードルール管理 | P1-1-7 |
| P1-4-2 | ローカルフォワード実装 | -L オプション相当 | P1-4-1 |
| P1-4-3 | リモートフォワード実装 | -R オプション相当 | P1-4-1 |
| P1-4-4 | ソケット管理 | Bun.listen統合 | P1-4-2 |
| P1-4-5 | フォワード状態監視 | 接続数、転送量 | P1-4-4 |
| P1-4-6 | PortForwarderテスト | ユニットテスト | P1-4-5 |

**完了条件**: SSHで接続し、ポートフォワーディングが動作すること

---

## フェーズ 2: CDPモジュール実装

### P2-1: CDPClient実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P2-1-1 | CDPClient基本クラス | WebSocket接続管理 | P1-4 |
| P2-1-2 | ターゲット取得 | /json/list API | P2-1-1 |
| P2-1-3 | メッセージ送受信 | JSON-RPC形式 | P2-1-1 |
| P2-1-4 | イベント購読 | CDP Domain イベント | P2-1-3 |
| P2-1-5 | タイムアウト処理 | 応答待ちタイムアウト | P2-1-3 |
| P2-1-6 | CDPClientテスト | ユニットテスト | P2-1-5 |

### P2-2: BrowserController実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P2-2-1 | BrowserController基本クラス | SSHClient注入 | P2-1-1 |
| P2-2-2 | Chrome起動コマンド生成 | オプション組み立て | P2-2-1 |
| P2-2-3 | リモートChrome起動 | SSH経由で実行 | P2-2-2 |
| P2-2-4 | Chrome終了処理 | プロセスkill | P2-2-3 |
| P2-2-5 | 既存Chrome検出 | ps/pgrep使用 | P2-2-1 |
| P2-2-6 | Chromeパス自動検出 | OS別パス検索 | P2-2-1 |
| P2-2-7 | BrowserControllerテスト | ユニットテスト | P2-2-6 |

### P2-3: PageController実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P2-3-1 | PageController基本クラス | CDPClient注入 | P2-1-6 |
| P2-3-2 | ナビゲーション実装 | Page.navigate | P2-3-1 |
| P2-3-3 | ページ読み込み待機 | Page.loadEventFired | P2-3-2 |
| P2-3-4 | スクリーンショット実装 | Page.captureScreenshot | P2-3-1 |
| P2-3-5 | PDF出力実装 | Page.printToPDF | P2-3-1 |
| P2-3-6 | JavaScript実行 | Runtime.evaluate | P2-3-1 |
| P2-3-7 | DOM操作 | DOM.querySelector等 | P2-3-1 |
| P2-3-8 | PageControllerテスト | ユニットテスト | P2-3-7 |

### P2-4: NetworkMonitor実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P2-4-1 | NetworkMonitor基本クラス | CDPClient注入 | P2-1-6 |
| P2-4-2 | ネットワーク監視開始 | Network.enable | P2-4-1 |
| P2-4-3 | リクエスト記録 | requestWillBeSent | P2-4-2 |
| P2-4-4 | レスポンス記録 | responseReceived | P2-4-2 |
| P2-4-5 | レスポンスボディ取得 | getResponseBody | P2-4-4 |
| P2-4-6 | HAR形式エクスポート | HAR 1.2仕様 | P2-4-5 |
| P2-4-7 | NetworkMonitorテスト | ユニットテスト | P2-4-6 |

**完了条件**: CDPでブラウザを制御し、スクリーンショット/ネットワーク記録ができること

---

## フェーズ 3: セッション・設定管理

### P3-1: SessionManager実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P3-1-1 | SessionManager基本クラス | コンポーネント統合 | P2-4 |
| P3-1-2 | 起動シーケンス実装 | SSH→Browser→PF→CDP | P3-1-1 |
| P3-1-3 | 終了シーケンス実装 | 逆順クリーンアップ | P3-1-1 |
| P3-1-4 | 状態管理 | SessionState追跡 | P3-1-1 |
| P3-1-5 | エラーリカバリ | 部分的失敗からの回復 | P3-1-4 |
| P3-1-6 | 便利メソッド実装 | navigateTo, takeScreenshot等 | P3-1-4 |
| P3-1-7 | SessionManagerテスト | 統合テスト | P3-1-6 |

### P3-2: ConfigManager実装

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P3-2-1 | ConfigManager基本クラス | ファイルI/O | P0-2 |
| P3-2-2 | 設定スキーマ定義 | AppConfig型 | P3-2-1 |
| P3-2-3 | 接続CRUD操作 | add/update/remove/get | P3-2-2 |
| P3-2-4 | パスワード暗号化 | AES-256-GCM | P3-2-3 |
| P3-2-5 | 設定バリデーション | 必須フィールド検証 | P3-2-2 |
| P3-2-6 | 設定マイグレーション | バージョン間移行 | P3-2-2 |
| P3-2-7 | インポート/エクスポート | JSON形式 | P3-2-3 |
| P3-2-8 | ConfigManagerテスト | ユニットテスト | P3-2-7 |

**完了条件**: セッションのライフサイクル管理と設定の永続化ができること

---

## フェーズ 4: CLI実装

### P4-1: CLI基盤

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P4-1-1 | cli/package.json作成 | commander, chalk, inquirer | P3-2 |
| P4-1-2 | エントリーポイント作成 | index.ts + bin設定 | P4-1-1 |
| P4-1-3 | 出力フォーマッター | table, json, raw形式 | P4-1-1 |
| P4-1-4 | エラーハンドリング | 統一的なエラー表示 | P4-1-2 |

### P4-2: 接続コマンド

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P4-2-1 | connect add | 新規接続追加 | P4-1-4 |
| P4-2-2 | connect list | 接続一覧表示 | P4-1-4 |
| P4-2-3 | connect remove | 接続削除 | P4-1-4 |
| P4-2-4 | connect test | 接続テスト | P4-1-4 |
| P4-2-5 | connect show | 接続詳細表示 | P4-1-4 |

### P4-3: セッションコマンド

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P4-3-1 | session start | セッション開始 | P4-2-5 |
| P4-3-2 | session stop | セッション終了 | P4-3-1 |
| P4-3-3 | session status | 状態表示 | P4-3-1 |

### P4-4: ブラウザコマンド

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P4-4-1 | browse goto | URL移動 | P4-3-3 |
| P4-4-2 | browse back/forward/reload | ナビゲーション | P4-4-1 |
| P4-4-3 | browse info | ページ情報表示 | P4-4-1 |
| P4-4-4 | screenshot take | スクリーンショット撮影 | P4-4-1 |
| P4-4-5 | screenshot batch | 一括撮影 | P4-4-4 |

### P4-5: ネットワークコマンド

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P4-5-1 | network start | 記録開始 | P4-4-3 |
| P4-5-2 | network stop | 記録停止 | P4-5-1 |
| P4-5-3 | network show | 記録表示 | P4-5-2 |
| P4-5-4 | network export | HAR/JSONエクスポート | P4-5-2 |

### P4-6: 対話モード

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P4-6-1 | 対話メニュー実装 | inquirerベース | P4-5-4 |
| P4-6-2 | セッション内コマンド | REPLライクな操作 | P4-6-1 |
| P4-6-3 | ヘルプ表示 | コマンド説明 | P4-6-1 |

**完了条件**: CLIから全機能を操作できること

---

## フェーズ 5: GUI実装

### P5-1: サーバー基盤

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P5-1-1 | gui/server/package.json | Hono依存 | P4-6 |
| P5-1-2 | サーバーエントリーポイント | Honoアプリ初期化 | P5-1-1 |
| P5-1-3 | ミドルウェア設定 | CORS, logging, error | P5-1-2 |
| P5-1-4 | 静的ファイル配信 | フロントエンドserve | P5-1-2 |

### P5-2: REST API

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P5-2-1 | 接続API | CRUD endpoints | P5-1-3 |
| P5-2-2 | セッションAPI | start/stop/status | P5-2-1 |
| P5-2-3 | ブラウザAPI | navigate/screenshot | P5-2-2 |
| P5-2-4 | ネットワークAPI | start/stop/export | P5-2-2 |

### P5-3: WebSocket

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P5-3-1 | WebSocket基盤 | 接続管理 | P5-2-4 |
| P5-3-2 | イベントブロードキャスト | state, network, console | P5-3-1 |

### P5-4: フロントエンド

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P5-4-1 | HTML/CSS基盤 | レイアウト、スタイル | P5-3-2 |
| P5-4-2 | 接続管理UI | 接続一覧、追加フォーム | P5-4-1 |
| P5-4-3 | セッション制御UI | 開始/停止ボタン、状態表示 | P5-4-2 |
| P5-4-4 | ブラウザ操作UI | URL入力、ナビボタン | P5-4-3 |
| P5-4-5 | ネットワーク監視UI | リクエスト一覧、詳細 | P5-4-4 |
| P5-4-6 | リアルタイム更新 | WebSocket連携 | P5-4-5 |

**完了条件**: WebブラウザからGUIで全機能を操作できること

---

## フェーズ 6: 品質・ドキュメント

### P6-1: テスト強化

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P6-1-1 | 統合テスト作成 | Docker環境でのテスト | P5-4 |
| P6-1-2 | E2Eテスト作成 | 実SSH環境テスト | P6-1-1 |
| P6-1-3 | カバレッジ測定 | 80%以上目標 | P6-1-2 |

### P6-2: ドキュメント

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P6-2-1 | README更新 | インストール、使い方 | P6-1-3 |
| P6-2-2 | API リファレンス | コア公開API | P6-2-1 |
| P6-2-3 | トラブルシューティング | よくある問題と解決策 | P6-2-1 |
| P6-2-4 | サンプルコード | 使用例 | P6-2-2 |

### P6-3: 最終調整

| ID | タスク | 説明 | 依存 |
|----|--------|------|------|
| P6-3-1 | パフォーマンス最適化 | ボトルネック解消 | P6-2-4 |
| P6-3-2 | エラーメッセージ改善 | ユーザーフレンドリー化 | P6-3-1 |
| P6-3-3 | リリース準備 | CHANGELOG, バージョニング | P6-3-2 |

---

## タスクサマリー

| フェーズ | 説明 | タスク数 |
|---------|------|---------|
| Phase 0 | プロジェクト初期化 | 9 |
| Phase 1 | SSHモジュール | 23 |
| Phase 2 | CDPモジュール | 26 |
| Phase 3 | セッション・設定管理 | 15 |
| Phase 4 | CLI実装 | 19 |
| Phase 5 | GUI実装 | 14 |
| Phase 6 | 品質・ドキュメント | 10 |
| **合計** | | **116** |

---

## 依存関係ダイアグラム

```
Phase 0 ──► Phase 1 ──► Phase 2 ──► Phase 3 ──► Phase 4 ──► Phase 5 ──► Phase 6
(基盤)      (SSH)       (CDP)       (統合)      (CLI)       (GUI)       (品質)
```

各フェーズは前のフェーズの完了が前提となります。
ただし、Phase 4 (CLI) と Phase 5 (GUI) は Phase 3 完了後に並行開発可能です。

---

## 推奨開発順序

1. **Phase 0**: まず基盤を整える（1日目）
2. **Phase 1**: SSHの安定した接続を確保（2-4日目）
3. **Phase 2**: CDP機能を追加（5-8日目）
4. **Phase 3**: 統合管理を実装（9-11日目）
5. **Phase 4**: CLIで機能検証（12-15日目）
6. **Phase 5**: GUI追加（16-19日目）
7. **Phase 6**: 品質向上（20日目以降）

**注**: 日数は目安であり、実際の進捗に応じて調整してください。
